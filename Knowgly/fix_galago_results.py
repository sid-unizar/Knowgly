# Fixes the .run files generated by galago
#   - Replaces dbpedia URIs with prefixes (for evaluation purposes)
#   - Increases scores by 1000 so that they are not negative (this happened, somehow, once)
#   - Replaces NaN's and empty scores with absurdly high scores so that they are noticed (this has only happened when querying with the same field weights across all fields, although that shouldn't be done)

import sys

def fix_galago_results(input_file, output_file):
    nan_counter = 9999999.0
    
    with open(input_file, 'r') as f_in, open(output_file, 'w') as f_out:
        for line in f_in:
            parts = line.split(' ')
            if len(parts) >= 3 and parts[2].startswith('http://'):
                parts[2] = '<' + parts[2].strip().replace('http://dbpedia.org/resource/', 'dbpedia:') + '>'
            
            
            if parts[4] == 'NaN' or parts[4] == '':
                parts[4] = str(nan_counter)
                nan_counter -= 1
            else:
                # Do not output negative scores, just in case (how does it even happen?)
                parts[4] = str(float(parts[4])+1000.0)
                
            new_line = ' '.join(parts).replace('       NaN', '')
            f_out.write(new_line)

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print("Usage: python fix_galago_results.py input_file output_file")
    else:
        input_file = sys.argv[1]
        output_file = sys.argv[2]
        fix_galago_results(input_file, output_file)
